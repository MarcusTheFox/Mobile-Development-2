# Отчёт 2

## **Lesson9**
Было проведено улучшение архитектуры проекта, созданного в ходе первой практической работы, по принципам чистой архитектуры.

Улучшение состояло из двух этапов:
1. Выделение логики работы с источниками данных (SharedPreferences) из класса-репозитория в отдельный, специализированный класс-хранилище (Storage).
2. Преобразование логических пакетов (domain, data) в физически независимые Gradle-модули для обеспечения строгого разделения слоев.

Были настроены Gradle-зависимости для корректной связи между модулями.

### Код
#### app/.../MainActivity.java
``` java
package ru.mirea.bublikov.lesson9;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;

import androidx.appcompat.app.AppCompatActivity;

import ru.mirea.bublikov.data.repository.MovieRepositoryImpl;
import ru.mirea.bublikov.data.storage.SharedPrefMovieStorage;
import ru.mirea.bublikov.data.storage.MovieStorage;
import ru.mirea.bublikov.domain.models.Movie;
import ru.mirea.bublikov.domain.repository.MovieRepository;
import ru.mirea.bublikov.domain.usecases.GetFavoriteFilmUseCase;
import ru.mirea.bublikov.domain.usecases.SaveMovieToFavoriteUseCase;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        MovieStorage storage = new SharedPrefMovieStorage(this);
        MovieRepository movieRepository = new MovieRepositoryImpl(storage);
        GetFavoriteFilmUseCase getFavoriteFilmUseCase = new GetFavoriteFilmUseCase(movieRepository);
        SaveMovieToFavoriteUseCase saveMovieToFavoriteUseCase = new SaveMovieToFavoriteUseCase(movieRepository);

        TextView textViewMovie = findViewById(R.id.textViewMovie);
        EditText editTextMovie = findViewById(R.id.editTextMovie);
        Button buttonSaveMovie = findViewById(R.id.buttonSaveMovie);
        Button buttonGetMovie = findViewById(R.id.buttonGetMovie);

        buttonSaveMovie.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                String text = editTextMovie.getText().toString();
                Movie movie = new Movie(2, text);
                boolean result = saveMovieToFavoriteUseCase.execute(movie);
                textViewMovie.setText(String.format("Save result %s", result));
            }
        });

        buttonGetMovie.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Movie movie = getFavoriteFilmUseCase.execute();
                textViewMovie.setText(String.format("Movie name: %s", movie.getName()));
            }
        });
    }
}
```
#### data/.../MovieStorage.java
``` java
package ru.mirea.bublikov.data.storage;

import ru.mirea.bublikov.domain.models.Movie;

public interface MovieStorage {
    boolean save(Movie movie);
    Movie get();
}
```
#### data/.../SharedPrefMovieStorage.java
``` java
package ru.mirea.bublikov.data.storage;

import android.content.Context;
import android.content.SharedPreferences;

import ru.mirea.bublikov.domain.models.Movie;

public class SharedPrefMovieStorage implements MovieStorage {
    private static final String PREFERENCES_NAME = "movie_prefs";
    private static final String KEY_MOVIE_NAME = "movie_name";
    private static final String DEFAULT_MOVIE_NAME = "Фильм не сохранен";

    private final SharedPreferences sharedPreferences;

    public SharedPrefMovieStorage(Context context) {
        this.sharedPreferences = context.getSharedPreferences(PREFERENCES_NAME, Context.MODE_PRIVATE);
    }

    @Override
    public boolean save(Movie movie) {
        sharedPreferences.edit().putString(KEY_MOVIE_NAME, movie.getName()).apply();
        return true;
    }

    @Override
    public Movie get() {
        String movieName = sharedPreferences.getString(KEY_MOVIE_NAME, DEFAULT_MOVIE_NAME);
        return new Movie(1, movieName);
    }
}
```
#### data/.../MovieRepositoryImpl.java
``` java
package ru.mirea.bublikov.data.repository;

import ru.mirea.bublikov.data.storage.MovieStorage;
import ru.mirea.bublikov.domain.models.Movie;
import ru.mirea.bublikov.domain.repository.MovieRepository;

public class MovieRepositoryImpl implements MovieRepository {
    private final MovieStorage movieStorage;

    public MovieRepositoryImpl(MovieStorage movieStorage) {
        this.movieStorage = movieStorage;
    }

    @Override
    public boolean saveMovie(Movie movie) {
        return movieStorage.save(movie);
    }

    @Override
    public Movie getMovie() {
        return movieStorage.get();
    }
}
```

## **ShoppingList**
Было проведено улучшение архитектуры проекта, созданного в ходе первой практической работы, по принципам чистой архитектуры.
Были выполнены задачи:
1. Создание прототипа приложения в приложении Figma.
2. Разделение проекта на независимые Gradle-модули (app, data, domain) для обеспечения строгого разделения слоев.
3. Реализацию авторизации с использованием Firebase Auth, распределив логику по соответствующим модулям.
4. Внедрение нескольких источников данных в data-слое (Room, SharedPreferences, Mock Network API).

### Прототип
<img width="2362" height="843" alt="2-ShoppingList-1" src="https://github.com/user-attachments/assets/5e62d2cc-f7fb-4318-813e-a5820f03cbe9" />

### Код
#### app/.../SignInActivity.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Intent;
import android.os.Bundle;
import android.text.TextUtils;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import com.google.firebase.auth.FirebaseAuth;

import ru.mirea.bublikov.data.repository.UserRepositoryImpl;
import ru.mirea.bublikov.domain.repository.AuthCallback;
import ru.mirea.bublikov.domain.repository.UserRepository;
import ru.mirea.bublikov.domain.usecases.LoginUseCase;
import ru.mirea.bublikov.domain.usecases.RegisterUseCase;
import ru.mirea.bublikov.shoppinglist.R;

public class SignInActivity extends AppCompatActivity {
    private EditText editTextEmail;
    private EditText editTextPassword;
    private Button buttonSignIn;
    private Button buttonRegister;

    private LoginUseCase loginUseCase;
    private RegisterUseCase registerUseCase;
    private FirebaseAuth mAuth;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_sign_in);

        editTextEmail = findViewById(R.id.editTextEmail);
        editTextPassword = findViewById(R.id.editTextPassword);
        buttonSignIn = findViewById(R.id.buttonSignIn);
        buttonRegister = findViewById(R.id.buttonRegister);

        UserRepository repository = new UserRepositoryImpl(this);
        loginUseCase = new LoginUseCase(repository);
        registerUseCase = new RegisterUseCase(repository);
        mAuth = FirebaseAuth.getInstance();

        if (mAuth.getCurrentUser() != null) {
            navigateToMainScreen();
            return;
        }

        buttonSignIn.setOnClickListener(v -> {
            if (!validateForm()) return;

            String email = editTextEmail.getText().toString();
            String password = editTextPassword.getText().toString();

            loginUseCase.execute(email, password, new AuthCallback() {
                @Override
                public void onSuccess() {
                    Toast.makeText(SignInActivity.this, "Вход успешен!", Toast.LENGTH_SHORT).show();
                    navigateToMainScreen();
                }

                @Override
                public void onFailure(String errorMessage) {
                    Toast.makeText(SignInActivity.this, "Ошибка входа: " + errorMessage, Toast.LENGTH_LONG).show();
                }
            });
        });

        buttonRegister.setOnClickListener(v -> {
            if (!validateForm()) return;

            String email = editTextEmail.getText().toString();
            String password = editTextPassword.getText().toString();

            registerUseCase.execute(email, password, new AuthCallback() {
                @Override
                public void onSuccess() {
                    Toast.makeText(SignInActivity.this, "Регистрация успешна!", Toast.LENGTH_SHORT).show();
                    navigateToMainScreen();

                }

                @Override
                public void onFailure(String errorMessage) {
                    Toast.makeText(SignInActivity.this, "Ошибка регистрации: " + errorMessage, Toast.LENGTH_LONG).show();
                }
            });
        });
    }

    private void navigateToMainScreen() {
        Intent intent = new Intent(this, MainActivity.class);
        startActivity(intent);
        finish();
    }

    private boolean validateForm() {
        if (TextUtils.isEmpty(editTextEmail.getText().toString())) {
            Toast.makeText(this, "Введите email", Toast.LENGTH_SHORT).show();
            return false;
        }
        if (TextUtils.isEmpty(editTextPassword.getText().toString())) {
            Toast.makeText(this, "Введите пароль", Toast.LENGTH_SHORT).show();
            return false;
        }
        return true;
    }
}
```
#### data/.../UserRepositoryImpl.java
``` java
package ru.mirea.bublikov.data.repository;

import android.content.Context;

import androidx.annotation.NonNull;

import com.google.android.gms.tasks.OnCompleteListener;
import com.google.android.gms.tasks.Task;
import com.google.firebase.auth.AuthResult;
import com.google.firebase.auth.FirebaseAuth;

import ru.mirea.bublikov.data.storage.sharedprefs.ClientStorage;
import ru.mirea.bublikov.data.storage.sharedprefs.SharedPrefsClientStorage;
import ru.mirea.bublikov.domain.repository.AuthCallback;
import ru.mirea.bublikov.domain.repository.UserRepository;

public class UserRepositoryImpl implements UserRepository {
    private final FirebaseAuth mAuth;
    private final ClientStorage clientStorage;

    public UserRepositoryImpl(Context context) {
        mAuth = FirebaseAuth.getInstance();
        clientStorage = new SharedPrefsClientStorage(context);
    }

    @Override
    public void loginUser(String login, String password, AuthCallback callback) {
        mAuth.signInWithEmailAndPassword(login, password)
                .addOnCompleteListener(new OnCompleteListener<AuthResult>() {
                    @Override
                    public void onComplete(@NonNull Task<AuthResult> task) {
                        if (task.isSuccessful()) {
                            clientStorage.saveEmail(login);
                            callback.onSuccess();
                        } else {
                            callback.onFailure(task.getException().getMessage());
                        }
                    }
                });
    }

    @Override
    public void registerUser(String login, String password, AuthCallback callback) {
        mAuth.createUserWithEmailAndPassword(login, password)
                .addOnCompleteListener(new OnCompleteListener<AuthResult>() {
                    @Override
                    public void onComplete(@NonNull Task<AuthResult> task) {
                        if (task.isSuccessful()) {
                            clientStorage.saveEmail(login);
                            callback.onSuccess();
                        } else {
                            callback.onFailure(task.getException().getMessage());
                        }
                    }
                });
    }
}
```
#### domain/.../AuthCallback.java
``` java
package ru.mirea.bublikov.domain.repository;

public interface AuthCallback {
    void onSuccess();
    void onFailure(String errorMessage);
}
```
#### data/.../ShopListMapper.java
``` java
package ru.mirea.bublikov.data.repository;

import java.util.ArrayList;
import java.util.List;

import ru.mirea.bublikov.data.storage.database.ShopItemDbModel;
import ru.mirea.bublikov.domain.models.ShopItem;

public class ShopListMapper {
    public ShopItem mapDbModelToEntity(ShopItemDbModel dbModel) {
        ShopItem entity = new ShopItem(dbModel.name, dbModel.count, dbModel.enabled);
        entity.setId(dbModel.id);
        return entity;
    }

    public ShopItemDbModel mapEntityToDbModel(ShopItem entity) {
        ShopItemDbModel dbModel = new ShopItemDbModel();

        if (entity.getId() != ShopItem.UNDEFINED_ID) {
            dbModel.id = entity.getId();
        }
        dbModel.name = entity.getName();
        dbModel.count = entity.getCount();
        dbModel.enabled = entity.isEnabled();
        return dbModel;
    }

    public List<ShopItem> mapListDbModelToListEntity(List<ShopItemDbModel> list) {
        List<ShopItem> result = new ArrayList<>();
        for (ShopItemDbModel dbModel : list) {
            result.add(mapDbModelToEntity(dbModel));
        }
        return result;
    }
}
```
#### data/.../ShoppingListRepositoryImpl.java
``` java
package ru.mirea.bublikov.data.repository;

import android.content.Context;

import androidx.room.Room;

import java.util.List;

import ru.mirea.bublikov.data.network.MockNetworkApi;
import ru.mirea.bublikov.data.network.NetworkApi;
import ru.mirea.bublikov.data.storage.database.AppDatabase;
import ru.mirea.bublikov.data.storage.database.ShopItemDbModel;
import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;

public class ShoppingListRepositoryImpl implements ShoppingListRepository {

    private final AppDatabase database;
    private final NetworkApi networkApi;
    private final ShopListMapper mapper = new ShopListMapper();

    public ShoppingListRepositoryImpl(Context context) {
        database = Room.databaseBuilder(context.getApplicationContext(),
                        AppDatabase.class, "database.db")
                .allowMainThreadQueries()
                .build();
        networkApi = new MockNetworkApi();
    }

    @Override
    public void addShopItem(ShopItem shopItem) {
        database.shopListDao().addShopItem(mapper.mapEntityToDbModel(shopItem));
        networkApi.syncData(getShopList());
    }

    @Override
    public void deleteShopItem(ShopItem shopItem) {
        database.shopListDao().deleteShopItem(shopItem.getId());
        networkApi.syncData(getShopList());
    }

    @Override
    public void editShopItem(ShopItem shopItem) {
        database.shopListDao().addShopItem(mapper.mapEntityToDbModel(shopItem));
        networkApi.syncData(getShopList());
    }

    @Override
    public ShopItem getShopItem(int shopItemId) {
        ShopItemDbModel dbModel = database.shopListDao().getShopItem(shopItemId);
        return mapper.mapDbModelToEntity(dbModel);
    }

    @Override
    public List<ShopItem> getShopList() {
        List<ShopItemDbModel> dbList = database.shopListDao().getShopList();
        return mapper.mapListDbModelToListEntity(dbList);
    }

    @Override
    public void markShopItem(ShopItem shopItem) {
        shopItem.setEnabled(!shopItem.isEnabled());
        editShopItem(shopItem);
    }
}
```
#### data/.../AppDatabase.java
``` java
package ru.mirea.bublikov.data.storage.database;

import androidx.room.Database;
import androidx.room.RoomDatabase;

@Database(entities = {ShopItemDbModel.class}, version = 1, exportSchema = false)
public abstract class AppDatabase extends RoomDatabase {
    public abstract ShopListDao shopListDao();
}
```
#### data/.../ShopItemDbModel.java
``` java
package ru.mirea.bublikov.data.storage.database;

import androidx.room.Entity;
import androidx.room.PrimaryKey;

@Entity(tableName = "shop_items")
public class ShopItemDbModel {
    @PrimaryKey(autoGenerate = true)
    public int id;
    public String name;
    public int count;
    public boolean enabled;
}

```
#### data/.../ShopListDao.java
``` java
package ru.mirea.bublikov.data.storage.database;

import androidx.room.Dao;
import androidx.room.Insert;
import androidx.room.OnConflictStrategy;
import androidx.room.Query;

import java.util.List;

@Dao
public interface ShopListDao {
    @Query("SELECT * FROM shop_items")
    List<ShopItemDbModel> getShopList();

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    void addShopItem(ShopItemDbModel shopItemDbModel);

    @Query("DELETE FROM shop_items WHERE id=:shopItemId")
    void deleteShopItem(int shopItemId);

    @Query("SELECT * FROM shop_items WHERE id=:shopItemId LIMIT 1")
    ShopItemDbModel getShopItem(int shopItemId);
}
```
#### data/.../NetworkApi.java
``` java
package ru.mirea.bublikov.data.network;

import java.util.List;

import ru.mirea.bublikov.domain.models.ShopItem;

public interface NetworkApi {
    boolean syncData(List<ShopItem> shopList);
}
```
#### data/.../MockNetworkApi.java
``` java
package ru.mirea.bublikov.data.network;

import java.util.List;

import ru.mirea.bublikov.domain.models.ShopItem;

public class MockNetworkApi implements NetworkApi {
    @Override
    public boolean syncData(List<ShopItem> shopList) {
        try {
            Thread.sleep(2000);
            System.out.println("Синхронизировано " + shopList.size() + " элементов с сервером.");
            return true;
        } catch (InterruptedException e) {
            e.printStackTrace();
            return false;
        }
    }
}
```
#### app/.../MainActivity.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.os.Bundle;
import android.widget.TextView;

import androidx.appcompat.app.AppCompatActivity;

import java.util.List;

import ru.mirea.bublikov.data.repository.ShoppingListRepositoryImpl;
import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;
import ru.mirea.bublikov.domain.usecases.GetShoppingListUseCase;
import ru.mirea.bublikov.shoppinglist.R;

public class MainActivity extends AppCompatActivity {
    private GetShoppingListUseCase getShoppingListUseCase;

    private TextView tvShopList;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        ShoppingListRepository repository = new ShoppingListRepositoryImpl(this);
        getShoppingListUseCase = new GetShoppingListUseCase(repository);

        tvShopList = findViewById(R.id.tv_shop_list);

        showShopList();
    }

    private void showShopList() {
        List<ShopItem> shopList = getShoppingListUseCase.execute();

        if (!shopList.isEmpty()) {
            StringBuilder sb = new StringBuilder();
            for (ShopItem item : shopList) {
                sb.append(item.getName())
                        .append(", кол-во: ").append(item.getCount())
                        .append(", куплен: ").append(item.isEnabled())
                        .append("\n\n");
            }
            tvShopList.setText(sb.toString());
        } else {
            tvShopList.setText("Список покупок пуст");
        }
    }
}
```
