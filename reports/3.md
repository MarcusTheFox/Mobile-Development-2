# Отчёт 3

## Lesson 9
Для перехода на архитектуру MVVM были внесены следующие изменения:
1. MainViewModel: Создан класс, унаследованный от androidx.lifecycle.ViewModel. В него была перенесена вся логика по работе с репозиторием и Use Cases. ViewModel теперь отвечает за загрузку и сохранение данных.
2. ViewModelFactory: Реализована фабрика для создания MainViewModel. Это позволило передать необходимые зависимости (в данном случае, MovieRepository) в конструктор ViewModel, изолировав его от Context и конкретных реализаций data-слоя.
3. LiveData: В MainViewModel создано поле MutableLiveData\<String> для хранения результата операций. Методы save() и load() теперь не возвращают значения, а помещают результат в LiveData.
4. MainActivity: Класс был значительно упрощен. Его единственными задачами остались: создание ViewModel через фабрику, подписка на LiveData для обновления TextView, и делегирование событий от кнопок соответствующим методам ViewModel.

### Экраны
<img width="423" height="894" alt="3-Lesson9-1" src="https://github.com/user-attachments/assets/a64f5b2b-d8d9-4324-adfc-6d9e1ac3f355" />

<img width="648" height="299" alt="3-Lesson9-2" src="https://github.com/user-attachments/assets/46be38c2-6d09-4cf2-b465-2897b9a4cb92" />

### Код
#### app/.../MainViewModel.java
``` java
package ru.mirea.bublikov.lesson9.presentation;

import android.util.Log;

import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import ru.mirea.bublikov.domain.models.Movie;
import ru.mirea.bublikov.domain.repository.MovieRepository;
import ru.mirea.bublikov.domain.usecases.GetFavoriteFilmUseCase;
import ru.mirea.bublikov.domain.usecases.SaveMovieToFavoriteUseCase;

public class MainViewModel extends ViewModel {
    private final MovieRepository movieRepository;
    private final MutableLiveData<String> favoriteMovie = new MutableLiveData<>();

    public MutableLiveData<String> getFavoriteMovie() {
        return favoriteMovie;
    }

    public MainViewModel(MovieRepository movieRepository) {
        this.movieRepository = movieRepository;
        Log.d("MainViewModel", "MainViewModel created");
    }

    public void setText(Movie movie) {
        boolean result = new SaveMovieToFavoriteUseCase(movieRepository).execute(movie);
        favoriteMovie.setValue(Boolean.toString(result));
    }

    public void getText() {
        Movie movie = new GetFavoriteFilmUseCase(movieRepository).execute();
        favoriteMovie.setValue(String.format("My favorite movie is %s", movie.getName()));
    }

    @Override
    protected void onCleared() {
        super.onCleared();
        Log.d("MainViewModel", "MainViewModel cleared");
    }
}

```

#### app/.../ViewModelFactory.java
``` java
package ru.mirea.bublikov.lesson9.presentation;

import android.content.Context;

import androidx.annotation.NonNull;
import androidx.lifecycle.ViewModel;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.bublikov.data.repository.MovieRepositoryImpl;
import ru.mirea.bublikov.data.storage.MovieStorage;
import ru.mirea.bublikov.data.storage.SharedPrefMovieStorage;
import ru.mirea.bublikov.domain.repository.MovieRepository;

public class ViewModelFactory implements ViewModelProvider.Factory {
    private final Context context;

    public ViewModelFactory(Context context) {
        this.context = context;
    }

    @NonNull
    @Override
    public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {
        MovieStorage movieStorage = new SharedPrefMovieStorage(context);
        MovieRepository movieRepository = new MovieRepositoryImpl(movieStorage);
        return (T) new MainViewModel(movieRepository);
    }
}

```

#### app/.../MainActivity.java
``` java
package ru.mirea.bublikov.lesson9.presentation;

import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;

import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.Observer;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.bublikov.domain.models.Movie;
import ru.mirea.bublikov.lesson9.R;

public class MainActivity extends AppCompatActivity {
    private MainViewModel mainViewModel;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        ViewModelFactory factory = new ViewModelFactory(this);
        mainViewModel = new ViewModelProvider(this, factory).get(MainViewModel.class);

        TextView textViewMovie = findViewById(R.id.textViewMovie);
        EditText editTextMovie = findViewById(R.id.editTextMovie);
        Button buttonSaveMovie = findViewById(R.id.buttonSaveMovie);
        Button buttonGetMovie = findViewById(R.id.buttonGetMovie);

        mainViewModel.getFavoriteMovie().observe(this, new Observer<String>() {
            @Override
            public void onChanged(String s) {
                textViewMovie.setText(s);
            }
        });

        buttonSaveMovie.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                String text = editTextMovie.getText().toString();
                Movie movie = new Movie(2, text);
                mainViewModel.setText(movie);
            }
        });

        buttonGetMovie.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                mainViewModel.getText();
            }
        });
    }
}
```

## ShoppingList

Проведено внедрение паттерна MVVM в приложение ShoppingList:
1. Вся логика и управление состоянием экранов перенесены из Activity в классы ViewModel.
2. Для автоматического обновления UI и сохранения данных при повороте экрана использована LiveData.
3. Создан отдельный экран для добавления/редактирования товара со своим ViewModel.
4. Реализована индикация загрузки данных через MediatorLiveData, который объединяет состояние локальной базы данных и фоновой сетевой синхронизации.

### Экраны

<img width="346" height="741" alt="3-ShoppingList-1" src="https://github.com/user-attachments/assets/e8e0d0d0-b376-449d-9e6e-30bb6b3b29e2" />

<img width="348" height="742" alt="3-ShoppingList-2" src="https://github.com/user-attachments/assets/78a22397-5cbe-4ec2-9372-1ef06317f1be" />

<img width="348" height="742" alt="3-ShoppingList-3" src="https://github.com/user-attachments/assets/4ce88a91-88ac-49a0-9415-17cd62daad7b" />

<img width="369" height="741" alt="3-ShoppingList-4" src="https://github.com/user-attachments/assets/9c794161-6416-4136-95ab-69165e16b55c" />

<img width="352" height="737" alt="3-ShoppingList-5" src="https://github.com/user-attachments/assets/23a62075-e228-4583-a294-920853d2b0f0" />

<img width="350" height="740" alt="3-ShoppingList-6" src="https://github.com/user-attachments/assets/96fe0b0f-d7a3-47ea-a5e3-b316d816428e" />

<img width="351" height="746" alt="3-ShoppingList-7" src="https://github.com/user-attachments/assets/65397bff-cea7-43c8-ad98-f1fc94438202" />

<img width="635" height="299" alt="3-ShoppingList-8" src="https://github.com/user-attachments/assets/1023361c-c226-402e-953a-10b74dcc66b6" />

### Код
#### app/.../MainActivity.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.ProgressBar;

import androidx.appcompat.app.AppCompatActivity;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.RecyclerView;

import com.google.android.material.floatingactionbutton.FloatingActionButton;

import ru.mirea.bublikov.shoppinglist.R;

public class MainActivity extends AppCompatActivity {
    private MainViewModel mainViewModel;
    private ShopListAdapter shopListAdapter;
    private RecyclerView recyclerView;
    private ProgressBar progressBar;
    private FloatingActionButton fabAddItem;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        recyclerView = findViewById(R.id.recyclerViewShopList);
        progressBar = findViewById(R.id.progressBar);
        fabAddItem = findViewById(R.id.fabAddItem);

        ViewModelFactory factory = new ViewModelFactory(this);
        mainViewModel = new ViewModelProvider(this, factory).get(MainViewModel.class);

        setupRecyclerView();
        observeViewModel();
        setupClickListeners();

        if (savedInstanceState == null) {
            mainViewModel.initialLoad();
        }
    }

    @Override
    protected void onResume() {
        super.onResume();
        mainViewModel.loadShopList();
    }

    private void observeViewModel() {
        mainViewModel.getShopList().observe(this, list -> {
            shopListAdapter.submitList(list);
        });

        mainViewModel.getIsLoading().observe(this, isLoading -> {
            progressBar.setVisibility(isLoading ? View.VISIBLE : View.GONE);
            recyclerView.setVisibility(isLoading ? View.GONE : View.VISIBLE);
        });
    }

    private void setupRecyclerView() {
        shopListAdapter = new ShopListAdapter();
        recyclerView.setAdapter(shopListAdapter);
    }

    private void setupClickListeners() {
        fabAddItem.setOnClickListener(v -> {
            Intent intent = ShopItemActivity.newIntentAddItem(this);
            startActivity(intent);
        });

        shopListAdapter.setOnShopItemClickListener(shopItem -> {
            Intent intent = ShopItemActivity.newIntentEditItem(this, shopItem.getId());
            startActivity(intent);
        });

        shopListAdapter.setOnMarkItemClickListener(shopItem -> {
            mainViewModel.markShopItem(shopItem);
        });

        shopListAdapter.setOnDeleteItemClickListener(shopItem -> {
            mainViewModel.deleteShopItem(shopItem);
        });
    }
}
```

#### app/.../MainViewModel.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.os.Handler;
import android.os.Looper;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import java.util.List;

import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;
import ru.mirea.bublikov.domain.usecases.GetShoppingListUseCase;

public class MainViewModel extends ViewModel {

    private final ShoppingListRepository repository;

    private final MutableLiveData<List<ShopItem>> shopList = new MutableLiveData<>();
    public LiveData<List<ShopItem>> getShopList() {
        return shopList;
    }

    private final MutableLiveData<Boolean> isLoading = new MutableLiveData<>(false);
    public LiveData<Boolean> getIsLoading() {
        return isLoading;
    }

    public MainViewModel(ShoppingListRepository repository) {
        this.repository = repository;
    }

    public void initialLoad() {
        isLoading.setValue(true);
        new Thread(() -> {
            repository.syncWithNetwork();
            refreshListFromDb();
            new Handler(Looper.getMainLooper()).post(() -> isLoading.setValue(false));
        }).start();
    }

    public void loadShopList() {
        new Thread(() -> {
            refreshListFromDb();
            repository.syncWithNetwork();
        }).start();
    }

    public void deleteShopItem(ShopItem shopItem) {
        new Thread(() -> {
            repository.deleteShopItem(shopItem);
            refreshListFromDb();
            repository.syncWithNetwork();
        }).start();
    }

    public void markShopItem(ShopItem shopItem) {
        new Thread(() -> {
            repository.markShopItem(shopItem);
            refreshListFromDb();
            repository.syncWithNetwork();
        }).start();
    }

    private void refreshListFromDb() {
        List<ShopItem> currentList = new GetShoppingListUseCase(repository).execute();
        shopList.postValue(currentList);
    }
}
```

#### app/.../ViewModelFactory.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Context;

import androidx.annotation.NonNull;
import androidx.lifecycle.ViewModel;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.bublikov.data.repository.ShoppingListRepositoryImpl;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;

public class ViewModelFactory implements ViewModelProvider.Factory {

    private final Context context;

    public ViewModelFactory(Context context) {
        this.context = context.getApplicationContext();
    }

    @NonNull
    @Override
    public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {
        ShoppingListRepository repository = new ShoppingListRepositoryImpl(context);

        if (modelClass.isAssignableFrom(MainViewModel.class)) {
            return (T) new MainViewModel(repository);
        } else if (modelClass.isAssignableFrom(ShopItemViewModel.class)) {
            return (T) new ShopItemViewModel(repository);
        }

        throw new IllegalArgumentException("Unknown ViewModel class: " + modelClass.getName());
    }
}

```

#### app/.../ShopItemActivity.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.widget.Button;
import android.widget.EditText;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.shoppinglist.R;

public class ShopItemActivity extends AppCompatActivity {

    private ShopItemViewModel viewModel;
    private EditText editTextName;
    private EditText editTextCount;
    private EditText editTextPrice;
    private Button buttonSave;

    private int shopItemId = ShopItem.UNDEFINED_ID;
    private String screenMode = MODE_UNKNOWN;

    private static final String EXTRA_SCREEN_MODE = "extra_mode";
    private static final String EXTRA_SHOP_ITEM_ID = "extra_shop_item_id";
    private static final String MODE_ADD = "mode_add";
    private static final String MODE_EDIT = "mode_edit";
    private static final String MODE_UNKNOWN = "";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_shop_item);

        parseIntent();
        initViews();

        ViewModelFactory factory = new ViewModelFactory(this);
        viewModel = new ViewModelProvider(this, factory).get(ShopItemViewModel.class);

        setupScreenMode();
        observeViewModel();
    }

    private void observeViewModel() {
        viewModel.shouldCloseScreen.observe(this, shouldClose -> {
            if (shouldClose) {
                finish();
            }
        });
    }

    private void setupScreenMode() {
        if (screenMode.equals(MODE_EDIT)) {
            setTitle("Редактировать товар");
            viewModel.getShopItem(shopItemId);
            viewModel.shopItem.observe(this, item -> {
                if (item != null) {
                    editTextName.setText(item.getName());
                    editTextCount.setText(String.valueOf(item.getCount()));
                    editTextPrice.setText(String.valueOf(item.getPrice()));
                }
            });
        } else {
            setTitle("Добавить товар");
        }

        buttonSave.setOnClickListener(v ->
            viewModel.saveShopItem(
                editTextName.getText().toString(),
                editTextCount.getText().toString(),
                editTextPrice.getText().toString()
            )
        );
    }

    private void initViews() {
        editTextName = findViewById(R.id.editTextName);
        editTextCount = findViewById(R.id.editTextCount);
        editTextPrice = findViewById(R.id.editTextPrice);
        buttonSave = findViewById(R.id.buttonSave);
    }

    private void parseIntent() {
        if (!getIntent().hasExtra(EXTRA_SCREEN_MODE)) {
            throw new RuntimeException("Screen mode is absent");
        }
        String mode = getIntent().getStringExtra(EXTRA_SCREEN_MODE);
        if (!mode.equals(MODE_ADD) && !mode.equals(MODE_EDIT)) {
            throw new RuntimeException("Unknown screen mode " + mode);
        }
        screenMode = mode;
        if (screenMode.equals(MODE_EDIT)) {
            if (!getIntent().hasExtra(EXTRA_SHOP_ITEM_ID)) {
                throw new RuntimeException("Shop item id is absent");
            }
            shopItemId = getIntent().getIntExtra(EXTRA_SHOP_ITEM_ID, ShopItem.UNDEFINED_ID);
        }
    }

    public static Intent newIntentAddItem(Context context) {
        Intent intent = new Intent(context, ShopItemActivity.class);
        intent.putExtra(EXTRA_SCREEN_MODE, MODE_ADD);
        return intent;
    }

    public static Intent newIntentEditItem(Context context, int shopItemId) {
        Intent intent = new Intent(context, ShopItemActivity.class);
        intent.putExtra(EXTRA_SCREEN_MODE, MODE_EDIT);
        intent.putExtra(EXTRA_SHOP_ITEM_ID, shopItemId);
        return intent;
    }
}
```

#### app/.../ShopItemViewModel.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;
import ru.mirea.bublikov.domain.usecases.AddItemToListUseCase;
import ru.mirea.bublikov.domain.usecases.EditItemUseCase;
import ru.mirea.bublikov.domain.usecases.GetShopItemUseCase;

public class ShopItemViewModel extends ViewModel {
    private final ShoppingListRepository repository;

    private MutableLiveData<ShopItem> _shopItem = new MutableLiveData<>();
    public LiveData<ShopItem> shopItem = _shopItem;

    private MutableLiveData<Boolean> _shouldCloseScreen = new MutableLiveData<>();
    public LiveData<Boolean> shouldCloseScreen = _shouldCloseScreen;

    public ShopItemViewModel(ShoppingListRepository repository) {
        this.repository = repository;
    }

    public void getShopItem(int itemId) {
        ShopItem item = new GetShopItemUseCase(repository).execute(itemId);
        _shopItem.setValue(item);
    }

    public void saveShopItem(String inputName, String inputCount, String inputPrice) {
        int count = Integer.parseInt(inputCount);
        double price = Double.parseDouble(inputPrice);

        ShopItem currentItem = _shopItem.getValue();

        new Thread(() -> {
            if (currentItem != null) {
                currentItem.setName(inputName);
                currentItem.setCount(count);
                currentItem.setPrice(price);
                new EditItemUseCase(repository).execute(currentItem);
            } else {
                new AddItemToListUseCase(repository).execute(new ShopItem(inputName, count, price, false));
            }
            _shouldCloseScreen.postValue(true);
        }).start();
    }
}
```

#### app/.../ShopListAdapter.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.CheckBox;
import android.widget.ImageButton;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.core.content.ContextCompat;
import androidx.recyclerview.widget.DiffUtil;
import androidx.recyclerview.widget.ListAdapter;
import androidx.recyclerview.widget.RecyclerView;

import ru.mirea.bublikov.domain.models.ShopItem;
import ru.mirea.bublikov.shoppinglist.R;

public class ShopListAdapter extends ListAdapter<ShopItem, ShopListAdapter.ShopItemViewHolder> {
    private OnShopItemClickListener onShopItemClickListener;
    private OnDeleteItemClickListener onDeleteItemClickListener;
    private OnMarkItemClickListener onMarkItemClickListener;

    protected ShopListAdapter() {
        super(new ShopItemDiffCallback());
    }

    public void setOnShopItemClickListener(OnShopItemClickListener listener) {
        this.onShopItemClickListener = listener;
    }

    public void setOnDeleteItemClickListener(OnDeleteItemClickListener listener) {
        this.onDeleteItemClickListener = listener;
    }

    public void setOnMarkItemClickListener(OnMarkItemClickListener listener) {
        this.onMarkItemClickListener = listener;
    }

    @NonNull
    @Override
    public ShopItemViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(parent.getContext()).inflate(R.layout.shop_item, parent, false);
        return new ShopItemViewHolder(view);
    }

    @Override
    public void onBindViewHolder(@NonNull ShopItemViewHolder holder, int position) {
        ShopItem shopItem = getItem(position);

        holder.textViewName.setText(shopItem.getName());
        holder.textViewCount.setText(String.format("Кол-во: %d", shopItem.getCount()));
        holder.textViewPrice.setText(String.format("%.2f руб./шт.", shopItem.getPrice()));

        holder.checkBoxEnabled.setOnCheckedChangeListener(null);
        holder.checkBoxEnabled.setChecked(shopItem.isEnabled());

        holder.itemView.setOnClickListener(v -> {
            if (onShopItemClickListener != null) {
                onShopItemClickListener.onShopItemClick(shopItem);
            }
        });

        holder.checkBoxEnabled.setOnCheckedChangeListener((buttonView, isChecked) -> {
            if (onMarkItemClickListener != null) {
                onMarkItemClickListener.onMarkItemClick(shopItem);
            }
        });

        holder.buttonDelete.setOnClickListener(v -> {
            if (onDeleteItemClickListener != null) {
                onDeleteItemClickListener.onDeleteItemClick(shopItem);
            }
        });

        int backgroundColorResId = shopItem.isEnabled()
                ? android.R.color.holo_green_light
                : android.R.color.white;
        holder.itemView.setBackgroundColor(ContextCompat.getColor(holder.itemView.getContext(), backgroundColorResId));
    }

    public static class ShopItemViewHolder extends RecyclerView.ViewHolder {
        final TextView textViewName;
        final TextView textViewCount;
        final TextView textViewPrice;
        final ImageButton buttonDelete;
        final CheckBox checkBoxEnabled;

        public ShopItemViewHolder(@NonNull View itemView) {
            super(itemView);
            textViewName = itemView.findViewById(R.id.textViewName);
            textViewCount = itemView.findViewById(R.id.textViewCount);
            textViewPrice = itemView.findViewById(R.id.textViewPrice);
            buttonDelete = itemView.findViewById(R.id.buttonDelete);
            checkBoxEnabled = itemView.findViewById(R.id.checkBoxEnabled);
        }
    }

    private static class ShopItemDiffCallback extends DiffUtil.ItemCallback<ShopItem> {
        @Override
        public boolean areItemsTheSame(@NonNull ShopItem oldItem, @NonNull ShopItem newItem) {
            return oldItem.getId() == newItem.getId();
        }

        @Override
        public boolean areContentsTheSame(@NonNull ShopItem oldItem, @NonNull ShopItem newItem) {
            return oldItem.equals(newItem);
        }
    }

    public interface OnShopItemClickListener {
        void onShopItemClick(ShopItem shopItem);
    }

    public interface OnDeleteItemClickListener {
        void onDeleteItemClick(ShopItem shopItem);
    }

    public interface OnMarkItemClickListener {
        void onMarkItemClick(ShopItem shopItem);
    }
}

```
