# Отчёт 5

## RetrofitApp
Создать приложение c использованием Retrofit и Picasso, которое загружает список задач с изображениями, отображает его и позволяет обновлять статус каждой задачи, отправляя изменения на сервер.

### Экраны

<img width="564" height="1194" alt="5 - RetrofitApp - 1" src="https://github.com/user-attachments/assets/7f9c3ce1-c237-432c-82aa-92382adc786c" />

<img width="557" height="1192" alt="5 - RetrofitApp - 2" src="https://github.com/user-attachments/assets/19a16f9e-64ef-47de-897c-7274ad58c5cc" />

<img width="560" height="1186" alt="5 - RetrofitApp - 3" src="https://github.com/user-attachments/assets/2d696e08-cc0c-40f7-a623-3ec7ec70ae34" />

### Код
#### Todo.java
``` java
package ru.mirea.bublikov.retrofitapp;

import com.google.gson.annotations.Expose;
import com.google.gson.annotations.SerializedName;

public class Todo {
    @SerializedName("userId")
    @Expose
    private Integer userId;
    @SerializedName("id")
    @Expose
    private Integer id;
    @SerializedName("title")
    @Expose
    private String title;
    @SerializedName("completed")
    @Expose
    private Boolean completed;

    public Integer getUserId() { return userId; }
    public void setUserId(Integer userId) { this.userId = userId; }
    public Integer getId() { return id; }
    public void setId(Integer id) { this.id = id; }
    public String getTitle() { return title; }
    public void setTitle(String title) { this.title = title; }
    public Boolean getCompleted() { return completed; }
    public void setCompleted(Boolean completed) { this.completed = completed; }
}

```

#### TodoViewHolder.java
``` java
package ru.mirea.bublikov.retrofitapp;

import android.view.View;
import android.widget.CheckBox;
import android.widget.ImageView;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.RecyclerView;

public class TodoViewHolder extends RecyclerView.ViewHolder {
    TextView textViewTitle;
    CheckBox checkBoxCompleted;
    ImageView imageView;

    public TodoViewHolder(@NonNull View itemView) {
        super(itemView);
        textViewTitle = itemView.findViewById(R.id.textViewTitle);
        checkBoxCompleted = itemView.findViewById(R.id.checkBoxCompleted);
        imageView = itemView.findViewById(R.id.imageView);
    }
}

```

#### TodoAdapter.java
``` java
package ru.mirea.bublikov.retrofitapp;

import android.content.Context;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.RecyclerView;

import com.squareup.picasso.Picasso;

import java.util.List;

public class TodoAdapter extends RecyclerView.Adapter<TodoViewHolder> {
    private LayoutInflater layoutInflater;
    private List<Todo> todos;
    private OnTodoCheckedChangeListener listener;

    public TodoAdapter(Context context, List<Todo> todoList) {
        this.layoutInflater = LayoutInflater.from(context);
        this.todos = todoList;
    }

    @NonNull
    @Override
    public TodoViewHolder onCreateViewHolder(@NonNull ViewGroup parent, int viewType) {
        View view = layoutInflater.inflate(R.layout.item, parent, false);
        return new TodoViewHolder(view);
    }

    @Override
    public void onBindViewHolder(@NonNull TodoViewHolder holder, int position) {
        Todo todo = todos.get(position);
        holder.textViewTitle.setText(todo.getTitle());
        holder.checkBoxCompleted.setChecked(todo.getCompleted());
        holder.checkBoxCompleted.setOnClickListener(v -> {
            boolean isChecked = holder.checkBoxCompleted.isChecked();
            if (listener != null) {
                listener.onTodoCheckedChanged(todo, isChecked);
            }
        });

        String imageUrl = "https://robohash.org/" + todo.getId() + "?set=set2";

        Picasso.get()
                .load(imageUrl)
                .resize(200, 150)
                .centerCrop()
                .into(holder.imageView);
    }

    @Override
    public int getItemCount() {
        return todos.size();
    }

    public void setOnTodoCheckedChangeListener(OnTodoCheckedChangeListener listener) {
        this.listener = listener;
    }

    public interface OnTodoCheckedChangeListener {
        void onTodoCheckedChanged(Todo todo, boolean isChecked);
    }
}

```

#### ApiService.java
``` java
package ru.mirea.bublikov.retrofitapp;

import java.util.List;

import retrofit2.Call;
import retrofit2.http.Body;
import retrofit2.http.GET;
import retrofit2.http.PUT;
import retrofit2.http.Path;

public interface ApiService {
    @GET("todos")
    Call<List<Todo>> getTodos();
    
    @PUT("todos/{id}")
    Call<Todo> updateTodo(@Path("id") int todoId, @Body Todo todo);
}

```

#### MainActivity.java
``` java
package ru.mirea.bublikov.retrofitapp;

import android.os.Bundle;
import android.util.Log;
import android.widget.Toast;

import androidx.activity.EdgeToEdge;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.graphics.Insets;
import androidx.core.view.ViewCompat;
import androidx.core.view.WindowInsetsCompat;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import java.util.List;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;

public class MainActivity extends AppCompatActivity {
    private static final String TAG = "MainActivity";
    private static final String BASE_URL = "https://jsonplaceholder.typicode.com/";

    private RecyclerView recyclerView;
    private TodoAdapter todoAdapter;
    private ApiService apiService;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        recyclerView = findViewById(R.id.recyclerView);
        recyclerView.setLayoutManager(new LinearLayoutManager(this));
        Retrofit retrofit = new Retrofit.Builder()
                .baseUrl(BASE_URL)
                .addConverterFactory(GsonConverterFactory.create())
                .build();
        apiService = retrofit.create(ApiService.class);

        fetchTodos();
    }

    private void fetchTodos() {
        apiService.getTodos().enqueue(new Callback<List<Todo>>() {
            @Override
            public void onResponse(Call<List<Todo>> call, Response<List<Todo>> response) {
                if (response.isSuccessful() && response.body() != null) {
                    List<Todo> todos = response.body();
                    todoAdapter = new TodoAdapter(MainActivity.this, todos);
                    todoAdapter.setOnTodoCheckedChangeListener((todo, isChecked) -> {
                        updateTodoStatus(todo, isChecked);
                    });
                    recyclerView.setAdapter(todoAdapter);
                } else {
                    Log.e(TAG, "onResponse (fetch): " + response.code());
                }
            }

            @Override
            public void onFailure(Call<List<Todo>> call, Throwable throwable) {
                Log.e(TAG, "onFailure (fetch): " + throwable.getMessage());
            }
        });
    }

    private void updateTodoStatus(Todo todo, boolean isChecked) {
        todo.setCompleted(isChecked);

        apiService.updateTodo(todo.getId(), todo).enqueue(new Callback<Todo>() {
            @Override
            public void onResponse(Call<Todo> call, Response<Todo> response) {
                if (response.isSuccessful()) {
                    Toast.makeText(MainActivity.this, "todo " + todo.getId() + " now is " + isChecked, Toast.LENGTH_SHORT).show();
                } else {
                    Log.e(TAG, "onResponse (update): " + response.code());
                }
            }

            @Override
            public void onFailure(Call<Todo> call, Throwable throwable) {
                Log.e(TAG, "onFailure (update): " + throwable.getMessage());
            }
        });
    }
}
```

## ShoppingList
В приложение ShoppingList реализована загрузка курсов валют с помощью Retrofit и отображение изображений флагов с помощью Picasso. Тестовые данные заменены на реальный API.

### Экраны

<img width="565" height="1197" alt="5 - ShoppingList - 1" src="https://github.com/user-attachments/assets/4501a560-5af4-451a-b4a4-c971f3c0c0c9" />

### Код
#### Currency.java
``` java
package ru.mirea.bublikov.domain.models;

public class Currency {
    private CurrencyCode code;
    private double rate;

    public Currency(CurrencyCode code, double rate) {
        this.code = code;
        this.rate = rate;
    }

    public CurrencyCode getCode() { return code; }
    public String getName() { return code.getFullName(); }
    public double getRate() { return rate; }
}
```

#### CurrencyCode.java
``` java
package ru.mirea.bublikov.domain.models;

public enum CurrencyCode {
    RUB("Российский рубль", "ru"),
    USD("Доллар США", "us"),
    EUR("Евро", "eu"),
    CNY("Китайский юань", "cn");

    private final String fullName;
    private final String countryCode;

    CurrencyCode(String fullName, String countryCode) {
        this.fullName = fullName;
        this.countryCode = countryCode;
    }

    public String getFullName() {
        return fullName;
    }

    public String getCountryCode() {
        return countryCode;
    }
}
```

#### CurrencyApiService.java
``` java
package ru.mirea.bublikov.data.network;

import retrofit2.Call;
import retrofit2.http.GET;
import ru.mirea.bublikov.data.network.model.CurrencyResponse;

public interface CurrencyApiService {
    @GET("v6/latest/RUB")
    Call<CurrencyResponse> getRates();
}

```

#### CurrencyResponse.java
``` java
package ru.mirea.bublikov.data.network.model;

import com.google.gson.annotations.SerializedName;

import java.util.Map;

public class CurrencyResponse {
    @SerializedName("rates")
    private Map<String, Double> rates;

    public Map<String, Double> getRates() {
        return rates;
    }
}

```

#### NetworkCurrencyRepositoryImpl.java
``` java
package ru.mirea.bublikov.data.repository;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import retrofit2.Response;
import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;
import ru.mirea.bublikov.data.network.CurrencyApiService;
import ru.mirea.bublikov.data.network.model.CurrencyResponse;
import ru.mirea.bublikov.domain.models.Currency;
import ru.mirea.bublikov.domain.models.CurrencyCode;
import ru.mirea.bublikov.domain.repository.CurrencyRepository;

public class NetworkCurrencyRepositoryImpl implements CurrencyRepository {
    private final CurrencyApiService apiService;
    private final String BASE_URL = "https://open.er-api.com/";

    public NetworkCurrencyRepositoryImpl() {
        Retrofit retrofit = new Retrofit.Builder()
                .baseUrl(BASE_URL)
                .addConverterFactory(GsonConverterFactory.create())
                .build();
        apiService = retrofit.create(CurrencyApiService.class);
    }

    @Override
    public List<Currency> getCurrencyRates() {
        List<Currency> resultList = new ArrayList<>();

        try {
            Response<CurrencyResponse> response = apiService.getRates().execute();

            if (response.isSuccessful() && response.body() != null) {
                Map<String, Double> rates = response.body().getRates();
                for (CurrencyCode code : CurrencyCode.values()) {
                    Double rate = rates.get(code.name());
                    if (rate != null) {
                        double rubRate = 1.0 / rate;
                        resultList.add(new Currency(code, rubRate));
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return resultList;
    }
}

```

#### CurrencyAdapter.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Context;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;

import androidx.recyclerview.widget.RecyclerView;

import com.squareup.picasso.Picasso;

import java.util.ArrayList;
import java.util.List;

import ru.mirea.bublikov.domain.models.Currency;
import ru.mirea.bublikov.shoppinglist.R;

public class CurrencyAdapter extends RecyclerView.Adapter<CurrencyViewHolder> {
    private List<Currency> currencies = new ArrayList<>();

    public void setItems(List<Currency> items) {
        this.currencies = items;
        notifyDataSetChanged();
    }

    @Override
    public CurrencyViewHolder onCreateViewHolder(final ViewGroup parent, int viewType) {
        View view = LayoutInflater.from(parent.getContext()).inflate(R.layout.currency_item, parent, false);
        return new CurrencyViewHolder(view);
    }

    @Override
    public void onBindViewHolder(CurrencyViewHolder holder, int position) {
        Currency currency = currencies.get(position);
        String countryCode = currency.getCode().getCountryCode();
        String flagUrl = "https://flagcdn.com/w160/" + countryCode + ".png";

        holder.getTextName().setText(String.format("%s (%s)", currency.getName(), currency.getCode()));
        holder.getTextRate().setText(String.format("%.2f RUB", currency.getRate()));
        Picasso.get()
                .load(flagUrl)
                .placeholder(R.drawable.ic_launcher_foreground)
                .error(R.drawable.ic_launcher_background)
                .into(holder.imageFlag);
    }

    @Override public int getItemCount() { return currencies.size(); }
}
```

#### CurrencyViewModel.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import java.util.List;

import ru.mirea.bublikov.domain.models.Currency;
import ru.mirea.bublikov.domain.repository.CurrencyRepository;
import ru.mirea.bublikov.domain.usecases.GetCurrencyRatesUseCase;

public class CurrencyViewModel extends ViewModel {
    private final GetCurrencyRatesUseCase getCurrencyRatesUseCase;
    private final MutableLiveData<List<Currency>> currencyList = new MutableLiveData<>();

    public LiveData<List<Currency>> getCurrencyList() {
        return currencyList;
    }

    public CurrencyViewModel(CurrencyRepository repository) {
        this.getCurrencyRatesUseCase = new GetCurrencyRatesUseCase(repository);
        loadCurrencies();
    }

    private void loadCurrencies() {
        new Thread(() -> {
            List<Currency> rates = getCurrencyRatesUseCase.execute();
            currencyList.postValue(rates);
        }).start();
    }
}

```

#### ViewModelFactory.java
``` java
package ru.mirea.bublikov.shoppinglist.presentation;

import android.content.Context;

import androidx.annotation.NonNull;
import androidx.lifecycle.ViewModel;
import androidx.lifecycle.ViewModelProvider;

import ru.mirea.bublikov.data.repository.NetworkCurrencyRepositoryImpl;
import ru.mirea.bublikov.data.repository.ShoppingListRepositoryImpl;
import ru.mirea.bublikov.domain.repository.CurrencyRepository;
import ru.mirea.bublikov.domain.repository.ShoppingListRepository;

public class ViewModelFactory implements ViewModelProvider.Factory {

    private final Context context;

    public ViewModelFactory(Context context) {
        this.context = context.getApplicationContext();
    }

    @NonNull
    @Override
    public <T extends ViewModel> T create(@NonNull Class<T> modelClass) {
        ShoppingListRepository repository = new ShoppingListRepositoryImpl(context);

        if (modelClass.isAssignableFrom(MainViewModel.class)) {
            return (T) new MainViewModel(repository);
        } else if (modelClass.isAssignableFrom(ShopItemViewModel.class)) {
            return (T) new ShopItemViewModel(repository);
        } else if (modelClass.isAssignableFrom(CurrencyViewModel.class)) {
            CurrencyRepository currencyRepository = new NetworkCurrencyRepositoryImpl();
            return (T) new CurrencyViewModel(currencyRepository);
        }

        throw new IllegalArgumentException("Unknown ViewModel class: " + modelClass.getName());
    }
}

```

